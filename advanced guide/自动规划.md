<img align="middle" src="./imgs/title.png">
  
QQ群：565401831  
游戏介绍及入手请移步：[hoho大佬简书教程](https://www.jianshu.com/p/5431cb7f42d3)  
[系列目录](https://zhuanlan.zhihu.com/p/104412058)  
Version：1.0   
Author：Scorpior   

# 自动规划
<img align="middle" src="./imgs/planning1.png">

## 引言
自动规划，英文 auto-planning（或者叫房间规划 room planning），在 Screeps 中指的是自动计算自己房间中每个建筑该在什么位置建造。有建筑工 creep 的代码后（没有的话快去教程里 copy 一个），配合自动规划的结果来自动在相应位置摆放工地，就可以实现房间的全自动升级。

自动规划是 Screeps 里少有的纯算法问题，输入是一个房间的地形图的静态数据，输出每个建筑的位置。整个问题由2~3种算法完成，下面逐一介绍。

本篇偏重算法，没有特别新奇的设计思想。

### 预备知识
定义一下本文将用到的几个概念。
#### 墙点
不可拆除的墙所在的位置称为墙点，通过`room.getTerrain().getRawBuffer()`获得地形数组后，对于一个`{x,y}`的位置，可以这样判断是否是墙：
```js 
if (terrain[y*50 + x] & TERRAIN_MASK_WALL) {
    // 是墙
} else {
    // 不是墙
}
```
#### 资源点
这里我们指在房间地图上天然就有的 source、mineral 和 controller，它们的共同特征是都不可通行，不可修路。占领时一般只考虑有2个 source 的房间，那么房内会有**4个资源点**。

## 流程
### 选择空地
我们第一步需要知道哪些位置可以摆建筑，有2个要求：
1. 找到足够大的空地
2. 选择距离资源点总路程最近的空地

这里有2个流程可以完成任务：
1. 计算出所有可行的空地，对每个空地执行4次`PathFinder.search()`获得到资源点的总路程
2. 计算出房间所有非墙点到资源点的总路程，然后每个可行的空地直接读取总路程即可

为了**控制计算量**，我选择先计算到每个资源点的路程图。
#### 计算路程图
因为修路以后沼泽和平原的移动时间相同，所以全部的非墙点可以视为一个无向无权图，取一个资源点用**广度优先遍历**就可以得到它到所有非墙点的距离。伪码如下：
```js 
function 计算一个资源的路程图(资源点pos，terrain) {
    let 待访问点集合 = [资源点pos];      // 初始化广度优先队列
    let 已知路程集合 = {资源点pos: 0};   // 起始位置路程为0
    for (let pos of 待访问点集合) {   // 遍历广度优先队列
        for (let 邻居pos of pos的八个方向相邻节点) {
            if (已知路程集合.has(邻居pos) || terrain[邻居pos.y*50 + 邻居pos.x] & TERRAIN_MASK_WALL) {   // 已访问过的点或者墙点
                continue;   // 无需访问
            }
            已知路程集合.add(邻居pos, pos.路程+1);    // 伪码，设置邻居节点是本节点路程+1
            待访问点集合.push(邻居pos);     // 把新节点加入广度优先队列
        }
    }
    return 已知路程集合;
}
```
`计算一个资源的路程图()`这个函数得到一个资源点的路程图，对4个资源点各调用1次就得到4个路程图，每个 pos 的路程按权重相加就可以得到总路程。这里的权重可以使得不同资源点对总路程有不同的影响力，总路程最小的点会靠近权重大的资源点。
```js 
function  计算总路程图(所有资源点, terrain) {
    let 路程图 = 全0的二维数组;
    for (let 资源点 of 所有资源点) {
        let 一个路程图 = 计算一个资源的路程图(资源点, terrain);
        for (let pos of 一个路程图) {
            路程图[pos].路程 += 资源点.权重 * 一个路程图[pos].路程;  // 伪码
        }
    }
    return 路程图;
} 
```
### 基本建筑

### 铺路

### 修墙

## 延伸
