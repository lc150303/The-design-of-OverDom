<img align="middle" src="./imgs/title.png">
  
QQ群：565401831  
游戏介绍及入手请移步：[hoho大佬简书教程](https://www.jianshu.com/p/5431cb7f42d3)  
[系列目录](https://zhuanlan.zhihu.com/p/104412058)  
Version：1.0  
Author：Scorpior

# Screeps 任务设计

## 引言
[OverMind](https://github.com/bencbartlett/Overmind/wiki/Tasks) 中就已经有了内容庞大的任务系统，是谁第一个在 Screeps 
游戏中首先提出任务机制的已经不得而知（有谁知道的可以告诉我），但非常确定的是**任务驱动是 Screeps 中一种非常强大的逻辑控制方式**。

在[运输模式](运输模式b.md)中我已经展示了一种任务驱动的工作方式，本篇打算从个人视角来分析**游戏中有哪些功能可以使用任务驱动**、**任务机制的组成部分**和**不同形式任务的优缺点**。

### 优点
“任务”并不是一个前所未有的概念，具体到编程中其实一个任务就是用一个结构体或者对象把一份工作的信息保存起来，直到这份工作被完成或者不再需要进行。从计算机专业的角度很容易理解，保存数据就意味着**节约了反复计算这个数据的** 
**cpu 消耗**，这是任务驱动的第一个收益。

此外，将数据保存起来后，也就可以按自己的需要共享给任何其他对象或其他模块读取，因此**算出数据的对象和使用数据的对象可以解耦合**。解耦合意味着我们可以根据实时需求而非常方便地**替换**算出数据的对象或使用数据的对象，也意味着**用新功能的对象替换原有对象**同样方便。因此任务驱动让代码可以**根据实时需求灵活改变行为**，还能**节省添加新功能的工作量**，这是任务驱动的第二个收益。

还有一个容易被忽视的点是，多种工作的数据都以任务的形式保存起来后，我们也就可以根据所有这些工作数据来**分析帝国整体状态**，再根据这些状态**灵活调整不同工作的优先级或者工作量**。以各种方式记录游戏数据都可以做到这一点，任务是其中之一，这是任务驱动的第三点收益。

### 任务的粒度
**一个任务**包含了多少功能或者多少动作是一个见仁见智的问题，以运输工作举例，最粗粒度的观念可以把“**运输**”整体看作一个任务，creep 在执行这个任务的过程中要决定当前该取资源还是放资源、去哪里取资源或去哪放资源，这样粒度的任务已经和角色驱动的功能一致了。中细粒度的任务可以把“**运输一种资源**”或者“**运输一趟**”作为一个任务，creep 在任务中不需要切换资源种类或者不需要选择取放地点，任务制的优点开始得到利用。最细粒度的任务一般把“**连续的同一种基本行动**”作为一个任务~~（毕竟没有人把行动每 1tick 作为一个任务）~~，因此“移动去目的地”、“取资源”、“放资源”就各是一个任务，OverMind 就采取了这种划分方式。

### 缺点
存储数据有什么缺点呢？你可能要回答占用内存，但在我看来游戏中的[存储空间是用不完的](存储机制.md)，所以让我们来看看其他方面。

首先在我应用中常出现的问题是**给灵活性带来延迟**，比如一个 creep 在执行一个耗时几十 tick 的任务时，临时发生了紧急情况，我们很难调用 creep 先处理新情况而不使原有工作出错，这里的出错主要指的是管理原有工作的逻辑可能没考虑被抢占的情况，代码容易 bug。OverMind 里采取了相当于任务栈的概念来实现中途变更的功能，有关联的任务组成一个调用链，新任务的插入可以视为压栈，creep 每次执行栈顶的任务，执行完成后返回到前一任务继续执行。 可以看出，为了在由缓存数据驱动的逻辑中**增加应变能力**，我们**需要额外增加很复杂的代码逻辑**，这在任务模式的实用中常常难以避免。

任务制中每个 creep 所承担的工作是随时改变的，具体来说就是由当时或之前的发布任务的逻辑决定，我们在看见 bug 时可能已经错过了真正出错的逻辑的运行时间，或者无法得知 creep 在执行谁发布的任务，这都导致**难以 debug**成为任务逻辑的另一个缺点，和多线程或者分布式编程很类似。为了改善这个问题，能采取的方法就是增加记录任务逻辑的运行情况，存储在 Memory 等**不易丢失**的位置（用 creep.say() 第二个参数置为 true 也是一个好方法），增加我们事后找到问题根源的概率（我曾经有个 link 的 bug 观察了一两个月才找到，虽然不是任务机制的问题）。

### 预备知识

#### 源和汇
称需要取出物资的对象为源（源节点），需要放入物资的对象为汇（汇节点）。

#### 事件链
“事件就是等待发布的任务，任务就是正在发生的事件”——我。~~（手动滑稽）~~  
[基本概念](事件链.md)。

## 物流系统：让萌新们开始思考任务
每一大佬都首先是一个萌新，每一个萌新最开始都没有任务系统。那么一个玩家啥时候最可能开始考虑使用任务系统呢？看到这篇文章的各位应该都经历了这个过程——有一天忽然发现搬运物资的工作逻辑写不出来了！这一切的起因都是 dev 让大家的 rcl 升得太快了~~（大误）~~，但既然无法改变 dev，我们只能自己解决这个问题。

无论任务划分的粒度如何，物流问题都由类似的基本定义组成，我们可以先描述这样一些元素：地图上固定分布着数量有限的节点（主要是建筑），每个节点在**某一个时刻**需要取出或者放入**一定量的某种资源**，每个节点之间需要一定的**移动时间**，同时数量有限的运输工随机分布在地图上，每个运输工有一定的**容量**，简化起见认为运输工移动速度相同。

建立一个任务就是把一些信息**绑定存储**，比如以运输一种资源或者运输一趟作为任务，就是把**一些源节点**、**一些汇节点**和**资源类型**进行绑定，这样的好处是比如在往源走的过程中就可以判断汇节点是否还需要资源，如果无效就可以及时取消任务。这样的坏处是比如在往旧的源走的过程中更近的位置出现了新的源（比如另一个 source 的 container 采满了），由于**源汇节点耦合**而难以最优化利用资源，但是这种小幅的效率损失不妨碍任务机制是完成全局运输工作的优秀机制。激进一点的做法是类似细粒度的任务划分那样，把移动、取、放三者独立封装，但是这种随时改变目标的任务**给多 creep 调度带来困难**，因为前述耦合的任务中我们很容易控制不会有2个 creep 做同一件事，而散装任务中我们要么每次变化时都**统一对所有节点进行分配**，要么**登记每个节点被 creep （任务）选取为目标的情况**即类似操作系统资源锁的机制。

绝大多数运输工作，包括

## 出生队列：当它需要帮别的房间生产 creep

## powerCreep：技能太多，dev 背锅

## 殖民与战争：任务影响了不止一个人（creep）

## 缺点与难题